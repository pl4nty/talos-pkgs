# References:
#   Trusted Firmware
#     - https://www.trustedfirmware.org/
#     - https://review.trustedfirmware.org/c/TF-A/trusted-firmware-a/+/21840
#     - https://review.trustedfirmware.org/plugins/gitiles/TF-A/trusted-firmware-a/+/fd91c4522395966250cec88625004c2ad5dff21e
#   U-Boot:
#     - https://u-boot.readthedocs.io/en/latest
#   Rockchip:
#     - http://opensource.rock-chips.com
#     - https://github.com/u-boot/u-boot/blob/master/doc/board/rockchip/rockchip.rst
#     - https://u-boot.readthedocs.io/en/latest/board/rockchip/rockchip.html
name: u-boot
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  - stage: openssl
steps:
  # {{ if eq .ARCH "aarch64" }} This in fact is YAML comment, but Go templating instruction is evaluated by bldr restricting build to arm64 only
  - sources:
      # download commit until it's merged
      # https://review.trustedfirmware.org/c/TF-A/trusted-firmware-a/+/21840
      - url: https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/snapshot/{{ .arm_trusted_firmware_version }}.tar.gz
        destination: arm-trusted-firmware.tar.gz
        sha256: "{{ .arm_trusted_firmware_sha256 }}"
        sha512: "{{ .arm_trusted_firmware_sha512 }}"
      - url: https://ftp.denx.de/pub/u-boot/u-boot-{{ .uboot_version }}.tar.bz2
        destination: u-boot.tar.bz2
        sha256: "{{ .uboot_sha256 }}"
        sha512: "{{ .uboot_sha512 }}"
    env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
      ARM_TRUSTED_FIRMWARE: arm-trusted-firmware
      ROCKCHIP_RKBIN: rockchip-rkbin
      U_BOOT: u-boot
    prepare:
      - |
        mkdir -p /usr/bin
        ln -sf /toolchain/bin/env /usr/bin/env
        ln -sf /toolchain/bin/python3 /toolchain/bin/python
        pip3 install pyelftools
      - |
        mkdir ${ARM_TRUSTED_FIRMWARE}
        tar -xzf arm-trusted-firmware.tar.gz --strip-components=1 -C ${ARM_TRUSTED_FIRMWARE}
      - |
        mkdir ${ROCKCHIP_RKBIN}
        cp /pkg/rk3588_ddr_lp4_2112MHz_lp5_2736MHz_v1.12_patched.bin ${ROCKCHIP_RKBIN}
      - |
        mkdir ${U_BOOT}
        tar -xjf u-boot.tar.bz2 --strip-components=1 -C ${U_BOOT}
        cd ${U_BOOT}
        make orangepi-5-rk3588s_defconfig
        sed -i "s/CONFIG_TOOLS_LIBCRYPTO=y/# CONFIG_TOOLS_LIBCRYPTO is not set/" .config
    build:
      - |
        cd ${ARM_TRUSTED_FIRMWARE}
        make realclean
        TF_LDFLAGS=--no-warn-rwx-segments CFLAGS=--param=min-pagesize=0 make -j $(nproc) PLAT=rk3588 DEBUG=0 bl31
      - |
        export ROCKCHIP_TPL=$(pwd)/${ROCKCHIP_RKBIN}/rk3588_ddr_lp4_2112MHz_lp5_2736MHz_v1.12_patched.bin
        export BL31=$(pwd)/${ARM_TRUSTED_FIRMWARE}/build/rk3588/release/bl31/bl31.elf
        cd ${U_BOOT}
        CFLAGS=-mno-outline-atomics make -j $(nproc) HOSTLDLIBS_mkimage="-lssl -lcrypto"

        # create spi image
        # https://github.com/armbian/build/blob/09e416e31cc01ece4533a65f02a470a4c21b90ea/config/sources/families/include/rockchip64_common.inc#L173-L178
        # tools/mkimage -n rk3588 -T rkspi -d tpl/u-boot-tpl.bin:spl/u-boot-spl.bin rkspi_tpl_spl.img
        tools/mkimage -n rk3588 -T rkspi -d spl/u-boot-spl.bin rkspi_tpl_spl.img

        dd if=/dev/zero of=rkspi_loader.img count=8128 status=none
        dd if=rkspi_tpl_spl.img of=rkspi_loader.img conv=notrunc status=none
        dd if=u-boot.itb of=rkspi_loader.img seek=768 conv=notrunc status=none
      #- |
      #  cd ${U_BOOT}
      #  dd if=/dev/zero of=rkspi_loader.img bs=1M count=0 seek=16
      #  /sbin/parted -s rkspi_loader.img mklabel gpt
      #  /sbin/parted -s rkspi_loader.img unit s mkpart idbloader 64 7167
      #  /sbin/parted -s rkspi_loader.img unit s mkpart vnvm 7168 7679
      #  /sbin/parted -s rkspi_loader.img unit s mkpart reserved_space 7680 8063
      #  /sbin/parted -s rkspi_loader.img unit s mkpart reserved1 8064 8127
      #  /sbin/parted -s rkspi_loader.img unit s mkpart uboot_env 8128 8191
      #  /sbin/parted -s rkspi_loader.img unit s mkpart reserved2 8192 16383
      #  /sbin/parted -s rkspi_loader.img unit s mkpart uboot 16384 32734
      #  dd if=rkspi_tpl_spl.img of=rkspi_loader.img seek=64 conv=notrunc
      #  dd if=u-boot.itb of=rkspi_loader.img seek=16384 conv=notrunc
    install:
      - |
        mkdir -p /rootfs
        cp -v ${U_BOOT}/u-boot-rockchip.bin /rootfs/orangepi_5
        cp -v ${U_BOOT}/rkspi_loader.img /rootfs/orangepi_5
  # {{ else }}
  - install:
      - |
        mkdir -p /rootfs
# {{ end }}
finalize:
  - from: /rootfs
    to: /
